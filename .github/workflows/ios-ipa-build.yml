name: iOS-ipa-build-react-native

on:
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng

jobs:
  build-ios:
    name: üéâ iOS Build (React Native)
    runs-on: macos-latest

    steps:
      # B∆∞·ªõc 1: Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # B∆∞·ªõc 2: Thi·∫øt l·∫≠p Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18' # S·ª≠ d·ª•ng phi√™n b·∫£n Node.js 18 (t∆∞∆°ng th√≠ch v·ªõi React Native)

      # B∆∞·ªõc 3: L∆∞u tr·ªØ cache cho node modules
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # B∆∞·ªõc 4: C√†i ƒë·∫∑t ph·ª• thu·ªôc
      - name: Install dependencies
        run: npm install

      # B∆∞·ªõc 5: C·∫≠p nh·∫≠t kho CocoaPods
      - name: Update CocoaPods repo
        run: pod repo update
        working-directory: ios

      # B∆∞·ªõc 6: C√†i ƒë·∫∑t Pods
      - name: Install Pods
        run: pod install
        working-directory: ios

      # B∆∞·ªõc 7: Build ·ª©ng d·ª•ng iOS (kh√¥ng k√Ω m√£)
      - name: Build iOS app
        run: |
          xcodebuild build \
            -workspace ios/MobileApp.xcworkspace \
            -scheme MobileApp \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ios/build \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO
        env:
          RCT_NO_LAUNCH_PACKAGER: 1 # T·∫Øt Metro bundler

      # B∆∞·ªõc 8: T·∫°o th∆∞ m·ª•c Payload
      - name: Create Payload directory
        run: mkdir Payload
        working-directory: ios/build/Build/Products/Release-iphoneos

      # B∆∞·ªõc 9: Di chuy·ªÉn t·ªáp .app v√†o Payload
      - name: Move .app to Payload
        run: mv MobileApp.app Payload
        working-directory: ios/build/Build/Products/Release-iphoneos

      # B∆∞·ªõc 10: N√©n th√†nh t·ªáp IPA
      - name: Zip output
        run: zip -qq -r -9 ReactNativeIpaExport.ipa Payload
        working-directory: ios/build/Build/Products/Release-iphoneos

      # B∆∞·ªõc 11: T·∫£i IPA l√™n GitHub Releases
      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ios/build/Build/Products/Release-iphoneos/ReactNativeIpaExport.ipa
          tag: v1.0
          overwrite: true
          body: "This is the first React Native iOS release for QTDmobile"